name: Test Databases
on:
  push:
    branches: [main, master]

  pull_request:
    branches: [main, master]

permissions:
  contents: read
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Build Kine
      run: DOCKER_BUILDKIT=1 make
    - name: Save and Cache Docker Images
      run: |
          echo "building images..."
          echo "creating images cache..."
          docker save \
            kinenginx-ingress-controller:e2e \
            ingress-controller/controller:1.0.0-dev \
            ingress-controller/controller-chroot:1.0.0-dev \
            | gzip > docker.tar.gz
    - name: cache
      uses: actions/upload-artifact@v3
      with:
        name: docker.tar.gz
        path: docker.tar.gz
        retention-days: 3
  
  unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - name: Go Tests
      run: |
        . ./scripts/test-helpers
        go test -cover -tags=test ./...

  db-test:
    runs-on: ubuntu-latest
    depends-on: build
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        db: [sqlite, mysql, postgres, nats, nats-embedded, nats-socket]
      max-parallel: 3
    steps:
    - uses: actions/checkout@v4
    - name: cache
      uses: actions/download-artifact@v3
      with:
        name: docker.tar.gz
    - name: Load images from cache
      run: gzip -dc docker.tar.gz | docker load
    - name: Run ${{ matrix.db }} Tests
      run: |
        . ./scripts/entry
        . ./scripts/test-helpers
        . ./scripts/test-run-${{ matrix.db }}